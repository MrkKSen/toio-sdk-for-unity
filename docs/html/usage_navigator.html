<!DOCTYPE html><html><head><meta charset="utf-8"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css"><style type="text/css">.markdown-body {padding: 20px 40px;}</style><style type="text/css">/*

github.com style (c) Vasily Polovnyov <vast@whiteants.net>

*/

.hljs {
  display: block;
  overflow-x: auto;
  padding: 0.5em;
  color: #333;
  background: #f8f8f8;
}

.hljs-comment,
.hljs-quote {
  color: #998;
  font-style: italic;
}

.hljs-keyword,
.hljs-selector-tag,
.hljs-subst {
  color: #333;
  font-weight: bold;
}

.hljs-number,
.hljs-literal,
.hljs-variable,
.hljs-template-variable,
.hljs-tag .hljs-attr {
  color: #008080;
}

.hljs-string,
.hljs-doctag {
  color: #d14;
}

.hljs-title,
.hljs-section,
.hljs-selector-id {
  color: #900;
  font-weight: bold;
}

.hljs-subst {
  font-weight: normal;
}

.hljs-type,
.hljs-class .hljs-title {
  color: #458;
  font-weight: bold;
}

.hljs-tag,
.hljs-name,
.hljs-attribute {
  color: #000080;
  font-weight: normal;
}

.hljs-regexp,
.hljs-link {
  color: #009926;
}

.hljs-symbol,
.hljs-bullet {
  color: #990073;
}

.hljs-built_in,
.hljs-builtin-name {
  color: #0086b3;
}

.hljs-meta {
  color: #999;
  font-weight: bold;
}

.hljs-deletion {
  background: #fdd;
}

.hljs-addition {
  background: #dfd;
}

.hljs-emphasis {
  font-style: italic;
}

.hljs-strong {
  font-weight: bold;
}
/*# sourceURL=/Users/yaeda/.nodebrew/node/v14.3.0/lib/node_modules/md-to-pdf/node_modules/highlight.js/styles/github.css*/</style></head>
<body class="markdown-body">
<h1 id="目次">目次</h1>
<ul>
<li><a href="usage_navigator.html#1-%E6%A6%82%E8%AA%AC">1. 概説</a></li>
<li><a href="usage_navigator.html#2-CubeNavigator%E3%82%AF%E3%83%A9%E3%82%B9API">2. CubeNavigator クラス API</a><ul>
<li><a href="usage_navigator.html#21-%E5%88%97%E6%8C%99%E5%9E%8B">2.1. 列挙型</a></li>
<li><a href="usage_navigator.html#22-%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%83%BC">2.2. パラメーター</a></li>
<li><a href="usage_navigator.html#23-%E3%83%97%E3%83%AD%E3%83%91%E3%83%86%E3%82%A3">2.3. プロパティ</a></li>
<li><a href="usage_navigator.html#24-NaviResult-%E6%A7%8B%E9%80%A0%E4%BD%93">2.4. NaviResult 構造体</a></li>
<li><a href="usage_navigator.html#25-%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89">2.5. メソッド</a></li>
</ul>
</li>
<li><a href="usage_navigator.html#3-HLAvoid%E3%82%AF%E3%83%A9%E3%82%B9API">3. HLAvoid クラス API</a><ul>
<li><a href="usage_navigator.html#31-%E3%82%B9%E3%82%AD%E3%83%A3%E3%83%B3%E7%B5%90%E6%9E%9C%E6%A7%8B%E9%80%A0%E4%BD%93-ScanResult">3.1. スキャン結果構造体 ScanResult</a></li>
<li><a href="usage_navigator.html#32-%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%83%BC">3.2. パラメーター</a></li>
<li><a href="usage_navigator.html#33-%E5%8F%96%E5%BE%97%E3%81%A7%E3%81%8D%E3%82%8B%E6%83%85%E5%A0%B1">3.3. 取得できる情報</a></li>
<li><a href="usage_navigator.html#34-%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89">3.4. メソッド</a></li>
</ul>
</li>
<li><a href="usage_navigator.html#4-Boids%E3%82%AF%E3%83%A9%E3%82%B9API">4. Boids クラス API</a><ul>
<li><a href="usage_navigator.html#41-%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%83%BC">4.1. パラメーター</a></li>
<li><a href="usage_navigator.html#42-%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89">4.2. メソッド</a></li>
</ul>
</li>
</ul>
<h1 id="1-概説">1. 概説</h1>
<p>Navigator とは、複数のロボット（コアキューブ）が存在する時、
お互いのロボットの動きを考慮しながら上手く移動するために作られたアルゴリズムです。</p>
<p>このアルゴリズムは主に「ヒューマンライク衝突回避」(HLAvoid)と「ボイド」(Boids)二つのアルゴリズムに基づいています。</p>
<ul>
<li>HLAvoid は自然に回避する手法</li>
<li>Boids は群れとして、同調した動作をする手法</li>
</ul>
<p>Navigator に実装されたクラスは皆ネームスペース <code>toio.Navigation</code> にあります。</p>
<h3 id="クラスダイアグラム">クラスダイアグラム</h3>
<div align="center"><img width="600" src="../res/navigator/arch.png"></div>

<p>Navigator クラスが２つのアルゴリズム HLAvoid と Boids を使っています。<br>
CubeNavigator クラスが Navigator クラスを継承して、インターフェイスとして CubeHandle クラスと連携しています。</p>
<p>詳しくは<a href="sys_navigator.html">Navigator の機能説明ドキュメント</a>を参考にしてください。</p>
<h3 id="モード">モード</h3>
<p>Navigator クラスには 3 つのモード（Navigator.mode）があります。</p>
<ul>
<li>AVOID： 衝突回避のみ</li>
<li>BOIDS： ボイドのみ</li>
<li>BOIDS_AVOID： ボイドと衝突回避の組み合わせ</li>
</ul>
<br>

<h1 id="2-cubenavigator-クラス-api">2. CubeNavigator クラス API</h1>
<p>ユーザーがナビゲーションの機能を使う際、直接に触れるのは Navigator クラスを継承した CubeNavigator クラスです。</p>
<h2 id="21-列挙型">2.1. 列挙型</h2>
<pre><code class="hljs c#"><span class="hljs-comment">// ナビゲーターのモード</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> Mode : <span class="hljs-keyword">byte</span>
{
    AVOID = <span class="hljs-number">0</span>,
    BOIDS = <span class="hljs-number">1</span>,
    BOIDS_AVOID = <span class="hljs-number">2</span>,
}

<span class="hljs-comment">// 他者をボイドと認識するか</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> Relation : <span class="hljs-keyword">byte</span>
{
    NONE = <span class="hljs-number">0</span>,   <span class="hljs-comment">// 他者をボイドとしない</span>
    BOIDS = <span class="hljs-number">1</span>,  <span class="hljs-comment">// 他者をボイドとする、動きを同調する</span>
}</code></pre><h2 id="22-パラメーター">2.2. パラメーター</h2>
<pre><code class="hljs c#"><span class="hljs-comment">// CubeNavigator</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> usePred = <span class="hljs-literal">false</span>;    <span class="hljs-comment">// CubeHandle の予測値を使うか</span>

<span class="hljs-comment">// Navigator</span>
<span class="hljs-keyword">public</span> Mode mode = Mode.AVOID;

<span class="hljs-comment">// Navigator.GetWaypointTo用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> p_surrogate_target = <span class="hljs-number">1</span>;       <span class="hljs-comment">// BOIDS_AVOID モード時、ボイドの方向への影響係数</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> p_speedratio_boidsavoid = <span class="hljs-number">1</span>;  <span class="hljs-comment">// BOIDS_AVOID モード時、ボイドの速度係数への影響係数</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> p_speedratio_boids = <span class="hljs-number">1</span>;       <span class="hljs-comment">// BOIDS モード時、ボイドの速度係数への影響係数</span></code></pre><h2 id="23-プロパティ">2.3. プロパティ</h2>
<pre><code class="hljs c#"><span class="hljs-keyword">public</span> Cube cube{ <span class="hljs-keyword">get</span>; }
<span class="hljs-keyword">public</span> CubeHandle handle{ <span class="hljs-keyword">get</span>; }
<span class="hljs-keyword">public</span> NaviResult result{ <span class="hljs-keyword">get</span>; }    <span class="hljs-comment">// 計算結果を保存</span>

<span class="hljs-comment">// Navigator から継承したプロパティ</span>
<span class="hljs-keyword">public</span> Entity entity { <span class="hljs-keyword">get</span>; }   <span class="hljs-comment">// 自身</span>
<span class="hljs-keyword">public</span> Boids boids { <span class="hljs-keyword">get</span>; }     <span class="hljs-comment">// ボイドアルゴ</span>
<span class="hljs-keyword">public</span> HLAvoid avoid { <span class="hljs-keyword">get</span>; }   <span class="hljs-comment">// 回避アルゴ</span></code></pre><h2 id="24-naviresult-構造体">2.4. NaviResult 構造体</h2>
<p>ナビゲーターの計算結果を持つ構造体です。<br>
以下のプロパティを持っています。</p>
<pre><code class="hljs c#"><span class="hljs-keyword">public</span> Vector waypoint { <span class="hljs-keyword">get</span>; }     <span class="hljs-comment">// ウェイポイント</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> speedRatio { <span class="hljs-keyword">get</span>; }   <span class="hljs-comment">// （ボイドからの）速度係数（既定値は１）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> speedLimit { <span class="hljs-keyword">get</span>; }   <span class="hljs-comment">// （回避からの）速度上限（既定値はDoubleの最大値）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> isCollision { <span class="hljs-keyword">get</span>; }    <span class="hljs-comment">// 衝突状態</span>

<span class="hljs-keyword">public</span> Mode mode { <span class="hljs-keyword">get</span>; }           <span class="hljs-comment">// ナビゲーターのモード（バックアップ情報）</span>
<span class="hljs-keyword">public</span> Vector avoidVector { <span class="hljs-keyword">get</span>; }  <span class="hljs-comment">// 回避の結果ベクトル（バックアップ情報）</span>
<span class="hljs-keyword">public</span> Vector boidsVector { <span class="hljs-keyword">get</span>; }  <span class="hljs-comment">// ボイドの結果ベクトル（バックアップ情報）</span></code></pre><h2 id="25-メソッド">2.5. メソッド</h2>
<h3 id="壁を設定">壁を設定</h3>
<h4 id="addwall">AddWall</h4>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddWall</span>(<span class="hljs-params">Wall wall</span>)</span>;</code></pre><p>壁を追加します</p>
<ul>
<li>wall<ul>
<li>定義：壁</li>
</ul>
</li>
</ul>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddWall</span>(<span class="hljs-params">List&lt;Wall&gt; walls</span>)</span>;</code></pre><p>複数の壁を追加します</p>
<ul>
<li>walls<ul>
<li>定義：壁リスト</li>
</ul>
</li>
</ul>
<h4 id="removewall">RemoveWall</h4>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RemoveWall</span>(<span class="hljs-params">Wall wall</span>)</span>;</code></pre><p>壁を削除します</p>
<ul>
<li>wall<ul>
<li>定義：壁</li>
</ul>
</li>
</ul>
<h4 id="clearwall">ClearWall</h4>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ClearWall</span>(<span class="hljs-params"></span>)</span>;</code></pre><p>壁をすべて削除します</p>
<h4 id="addborder">AddBorder</h4>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddBorder</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> width=<span class="hljs-number">60</span>, <span class="hljs-keyword">int</span> x1=<span class="hljs-number">0</span>, <span class="hljs-keyword">int</span> x2=<span class="hljs-number">500</span>, <span class="hljs-keyword">int</span> y1=<span class="hljs-number">0</span>, <span class="hljs-keyword">int</span> y2=<span class="hljs-number">500</span></span>)</span>;</code></pre><p>マットにボーダー付けたい場合、東西南北に壁を一斉に作るメソッドです。<br>
CubeNavigator をインスタンス化する際、自動的に <code>AddBorder(70);</code> が呼ばれます。</p>
<ul>
<li>width<ul>
<li>定義：壁の厚さの半分</li>
<li>既定値：60</li>
</ul>
</li>
<li>x1<ul>
<li>定義：ｙ方向の一本目の壁の中央のｘ座標</li>
<li>既定値：0</li>
</ul>
</li>
<li>x2<ul>
<li>定義：ｙ方向の二本目の壁の中央のｘ座標</li>
<li>既定値：500</li>
</ul>
</li>
<li>y1<ul>
<li>定義：ｘ方向の一本目の壁の中央のｙ座標</li>
<li>既定値：0</li>
</ul>
</li>
<li>y2<ul>
<li>定義：ｘ方向の二本目の壁の中央のｙ座標</li>
<li>既定値：500</li>
</ul>
</li>
</ul>
<p>既定値を例として、x 座標 -60 ~ 60, 440 ~ 560 と y 座標 -60 ~ 60, 440 ~ 560 は壁になってナビゲーターに回避されます。</p>
<h3 id="認識できる他者を設定">認識できる他者を設定</h3>
<h4 id="addother">AddOther</h4>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddOther</span>(<span class="hljs-params">Navigator other, Relation relation=Relation.BOIDS</span>)</span>;</code></pre><p>他ナビゲーターを認識できるようにします</p>
<ul>
<li>other<ul>
<li>定義：他 Navigator</li>
</ul>
</li>
<li>relation<ul>
<li>定義：ボイドか否か</li>
<li>既定値：<a href="usage_navigator.html#21-%E5%88%97%E6%8C%99%E5%9E%8B">Relation.BOIDS</a></li>
</ul>
</li>
</ul>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddOther</span>(<span class="hljs-params">List&lt;CubeNavigator&gt; others, Relation relation=Relation.BOIDS</span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddOther</span>(<span class="hljs-params">List&lt;Navigator&gt; others, Relation relation=Relation.BOIDS</span>)</span>;</code></pre><p>複数の他ナビゲーターを認識できるようにします</p>
<ul>
<li>others<ul>
<li>定義：他 Navigator リスト</li>
</ul>
</li>
</ul>
<h4 id="removeother">RemoveOther</h4>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RemoveOther</span>(<span class="hljs-params">Navigator other</span>)</span>;</code></pre><p>他のナビゲーターを認識できなくします</p>
<ul>
<li>other<ul>
<li>定義：他 Navigator</li>
</ul>
</li>
</ul>
<h4 id="clearother">ClearOther</h4>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ClearOther</span>(<span class="hljs-params"></span>)</span>;</code></pre><p>すべての認識できる対象を削除します</p>
<h4 id="cleargnavigators">ClearGNavigators</h4>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ClearGNavigators</span>(<span class="hljs-params"></span>)</span>;</code></pre><p>全ての CubeNavigator を持つ静的リスト<code>gNavigators</code>をクリアします</p>
<p><code>gNavigators</code>は CubeNavigator が新規にインスタンス化された際、
自動的に認識できる他者を設定する為のリストです。</p>
<p>CubeNavigator のインスタンスが作り直された場合、
本メソッドを呼び出してクリアするか、
各 CubeNavigator インスタンスが <code>ClearOther</code>と<code>AddOther</code>で手動的に設定するか、
いずれかを行ってください。</p>
<h3 id="ボイドとする他者を設定">ボイドとする他者を設定</h3>
<h4 id="setrelation">SetRelation</h4>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetRelation</span>(<span class="hljs-params">Navigator other, Relation relation</span>)</span>;</code></pre><p>他ナビゲーターをボイドとするかしないかを設定します</p>
<ul>
<li>other<ul>
<li>定義：他 Navigator</li>
</ul>
</li>
<li>relation<ul>
<li>定義：ボイドか否か <a href="usage_navigator.html#21-%E5%88%97%E6%8C%99%E5%9E%8B">（Relation）</a></li>
</ul>
</li>
</ul>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetRelation</span>(<span class="hljs-params">List&lt;CubeNavigator&gt; others, Relation relation</span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetRelation</span>(<span class="hljs-params">List&lt;Navigator&gt; others, Relation relation</span>)</span>;</code></pre><p>複数の他ナビゲーターをボイドとするかしないかを設定します</p>
<ul>
<li>others<ul>
<li>定義：他 Navigator リスト</li>
</ul>
</li>
</ul>
<h3 id="状態の更新">状態の更新</h3>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>(<span class="hljs-params"></span>)</span>;</code></pre><p>計算に使うキューブの状態を更新します</p>
<p>ナビゲーションの計算を行うフレームで、計算の前に一回実行してください。</p>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>(<span class="hljs-params"><span class="hljs-keyword">bool</span> usePred</span>)</span>;</code></pre><p>状態予測のありなしを指定して計算に使うキューブの状態を更新します</p>
<ul>
<li>usePred<ul>
<li>定義：状態予測のありなし</li>
</ul>
</li>
</ul>
<h3 id="ウェイポイントの計算">ウェイポイントの計算</h3>
<h4 id="getwaypointto">GetWaypointTo</h4>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> NaviResult <span class="hljs-title">GetWaypointTo</span>(<span class="hljs-params"><span class="hljs-keyword">double</span> x, <span class="hljs-keyword">double</span> y</span>)</span>;</code></pre><p>目標座標に移動するウェイポイントを計算します</p>
<ul>
<li>x<ul>
<li>定義：目標ｘ座標</li>
<li>範囲：任意</li>
</ul>
</li>
<li>y<ul>
<li>定義：目標ｙ座標</li>
<li>範囲：任意</li>
</ul>
</li>
<li>戻り値<ul>
<li>定義：ナビゲーション計算結果 <a href="usage_navigator.html#24-NaviResult-%E6%A7%8B%E9%80%A0%E4%BD%93">（NaviResult）</a></li>
</ul>
</li>
</ul>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> NaviResult <span class="hljs-title">GetWaypointTo</span>(<span class="hljs-params">Vector pos</span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> NaviResult <span class="hljs-title">GetWaypointTo</span>(<span class="hljs-params">Vector2 pos</span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> NaviResult <span class="hljs-title">GetWaypointTo</span>(<span class="hljs-params">Vector2Int pos</span>)</span>;</code></pre><p>目標座標に移動するウェイポイントを計算します</p>
<ul>
<li>pos<ul>
<li>目標座標</li>
</ul>
</li>
</ul>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> NaviResult <span class="hljs-title">GetWaypointTo</span>(<span class="hljs-params">Entity target</span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> NaviResult <span class="hljs-title">GetWaypointTo</span>(<span class="hljs-params">Navigator target</span>)</span>;</code></pre><p>目標個体に移動するウェイポイントを計算します</p>
<ul>
<li>target<ul>
<li>目標個体</li>
</ul>
</li>
</ul>
<h4 id="getwaypointaway">GetWaypointAway</h4>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> NaviResult <span class="hljs-title">GetWaypointAway</span>(<span class="hljs-params"><span class="hljs-keyword">double</span> x, <span class="hljs-keyword">double</span> y</span>)</span>;</code></pre><p>目標座標から離れるウェイポイントを計算します</p>
<ul>
<li>x<ul>
<li>定義：目標ｘ座標</li>
<li>範囲：任意</li>
</ul>
</li>
<li>y<ul>
<li>定義：目標ｙ座標</li>
<li>範囲：任意</li>
</ul>
</li>
<li>戻り値<ul>
<li>定義：ナビゲーション計算結果 <a href="usage_navigator.html#24-NaviResult-%E6%A7%8B%E9%80%A0%E4%BD%93">（NaviResult）</a></li>
</ul>
</li>
</ul>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> NaviResult <span class="hljs-title">GetWaypointAway</span>(<span class="hljs-params">Vector pos</span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> NaviResult <span class="hljs-title">GetWaypointAway</span>(<span class="hljs-params">Vector2 pos</span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> NaviResult <span class="hljs-title">GetWaypointAway</span>(<span class="hljs-params">Vector2Int pos</span>)</span>;</code></pre><p>目標座標から離れるウェイポイントを計算します</p>
<ul>
<li>pos<ul>
<li>目標座標</li>
</ul>
</li>
</ul>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> NaviResult <span class="hljs-title">GetWaypointAway</span>(<span class="hljs-params">Entity target</span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> NaviResult <span class="hljs-title">GetWaypointAway</span>(<span class="hljs-params">Navigator target</span>)</span>;</code></pre><p>目標個体から離れるウェイポイントを計算します</p>
<ul>
<li>target<ul>
<li>目標個体</li>
</ul>
</li>
</ul>
<br>

<p>サンプルコード</p>
<pre><code class="hljs c#"><span class="hljs-comment">// ウェイポイントを計算</span>
NaviResult res = cubeNavigator.GetWaypointTo(x, y);
<span class="hljs-comment">// 目標速度 targetSpd を spd に調整</span>
<span class="hljs-keyword">double</span> spd = Min(res.speedLimit, targetSpd * res.speedRatio);
<span class="hljs-comment">// ウェイポイントに向かう Movement を計算</span>
Movement mv = cubeNavigator.handle.Move2Target(res.waypoint, maxSpd:spd);
<span class="hljs-comment">// Movement を実行</span>
mv.Exec();</code></pre><br>

<h3 id="ナビゲーターを実行">ナビゲーターを実行</h3>
<p>前述ウェイポイントの計算と計算結果を利用して Movement の計算との過程を統合し、使いやすいメソッドを用意しています。</p>
<p>計算過程をカスタマイズしない場合は直接にこちらのメソッドを使えば良いです。</p>
<h4 id="navi2target">Navi2Target</h4>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> Movement <span class="hljs-title">Navi2Target</span>(<span class="hljs-params"><span class="hljs-keyword">double</span> x, <span class="hljs-keyword">double</span> y, <span class="hljs-keyword">int</span> maxSpd=<span class="hljs-number">70</span>, <span class="hljs-keyword">int</span> rotateTime=<span class="hljs-number">250</span>, <span class="hljs-keyword">double</span> tolerance=<span class="hljs-number">20</span></span>)</span>;</code></pre><p>目標座標にナビゲーションする Movement を計算します</p>
<ul>
<li>x<ul>
<li>定義：目標ｘ座標</li>
<li>範囲：任意</li>
</ul>
</li>
<li>y<ul>
<li>定義：目標ｙ座標</li>
<li>範囲：任意</li>
</ul>
</li>
<li>maxSpd<ul>
<li>定義：最大速度の指示値</li>
<li>範囲：<ul>
<li>[Version 2.0.0] 0~100</li>
<li>[Version 2.1.0] 0~115</li>
</ul>
</li>
<li>既定値：70</li>
</ul>
</li>
<li>rotateTime<ul>
<li>定義：希望回転時間（ms）</li>
<li>範囲：100 ~ 2550</li>
<li>既定値：250</li>
<li>説明：rotateTime で目標に向けるように回転指示値を出す。<br>
小さい値を入れると早く回転し、大きな値を入れるとゆっくりと回転します。正確な回転時間ではなく、だいたいの目安です。<br>
200 以下になると不安定になる可能性があります。</li>
</ul>
</li>
<li>tolerance<ul>
<li>定義：到達判定の閾値（距離）</li>
<li>既定値：20</li>
<li>説明：目標との距離が tolerance 以下になると、到達だと判断する。</li>
</ul>
</li>
<li>戻り値<ul>
<li>定義：移動命令 <a href="usage_cubehandle.html#22-Movement-%E6%A7%8B%E9%80%A0%E4%BD%93">（Movement）</a></li>
</ul>
</li>
</ul>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> Movement <span class="hljs-title">Navi2Target</span>(<span class="hljs-params">Vector pos, <span class="hljs-keyword">int</span> maxSpd=<span class="hljs-number">70</span>, <span class="hljs-keyword">int</span> rotateTime=<span class="hljs-number">250</span>, <span class="hljs-keyword">double</span> tolerance=<span class="hljs-number">20</span></span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> Movement <span class="hljs-title">Navi2Target</span>(<span class="hljs-params">Vector2 pos, <span class="hljs-keyword">int</span> maxSpd=<span class="hljs-number">70</span>, <span class="hljs-keyword">int</span> rotateTime=<span class="hljs-number">250</span>, <span class="hljs-keyword">double</span> tolerance=<span class="hljs-number">20</span></span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> Movement <span class="hljs-title">Navi2Target</span>(<span class="hljs-params">Vector2Int pos, <span class="hljs-keyword">int</span> maxSpd=<span class="hljs-number">70</span>, <span class="hljs-keyword">int</span> rotateTime=<span class="hljs-number">250</span>, <span class="hljs-keyword">double</span> tolerance=<span class="hljs-number">20</span></span>)</span>;</code></pre><p>目標座標にナビゲーションする Movement を計算します</p>
<ul>
<li>pos<ul>
<li>定義：目標座標</li>
</ul>
</li>
</ul>
<h4 id="naviawaytarget">NaviAwayTarget</h4>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> Movement <span class="hljs-title">NaviAwayTarget</span>(<span class="hljs-params"><span class="hljs-keyword">double</span> x, <span class="hljs-keyword">double</span> y, <span class="hljs-keyword">int</span> maxSpd=<span class="hljs-number">70</span>, <span class="hljs-keyword">int</span> rotateTime=<span class="hljs-number">250</span></span>)</span>;</code></pre><p>目標座標から離れるようにナビゲーションする Movement を計算します</p>
<ul>
<li>x<ul>
<li>定義：目標ｘ座標</li>
<li>範囲：任意</li>
</ul>
</li>
<li>y<ul>
<li>定義：目標ｙ座標</li>
<li>範囲：任意</li>
</ul>
</li>
<li>maxSpd<ul>
<li>定義：最大速度の指示値</li>
<li>範囲：<ul>
<li>[Version 2.0.0] 0~100</li>
<li>[Version 2.1.0] 0~115</li>
</ul>
</li>
<li>既定値：70</li>
</ul>
</li>
<li>rotateTime<ul>
<li>定義：希望回転時間（ms）</li>
<li>範囲：100 ~ 2550</li>
<li>既定値：250</li>
<li>説明：rotateTime で目標に向けるように回転指示値を出す。<br>
小さい値を入れると早く回転し、大きな値を入れるとゆっくりと回転します。正確な回転時間ではなく、だいたいの目安です。<br>
200 以下になると不安定になる可能性があります。</li>
</ul>
</li>
<li>戻り値<ul>
<li>定義：移動命令 <a href="usage_cubehandle.html#22-Movement-%E6%A7%8B%E9%80%A0%E4%BD%93">（Movement）</a></li>
<li>説明：</li>
</ul>
</li>
</ul>
<p>Navi2Target が返す Movement.reached は目標への距離で判定していますが、<br>
NaviAwayTarget の場合は明確な「到達」の定義がないため、<br>ウェイポイントへ移動する Move2Target の Movement を返します。</p>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> Movement <span class="hljs-title">NaviAwayTarget</span>(<span class="hljs-params">Vector pos, <span class="hljs-keyword">int</span> maxSpd=<span class="hljs-number">70</span>, <span class="hljs-keyword">int</span> rotateTime=<span class="hljs-number">250</span></span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> Movement <span class="hljs-title">NaviAwayTarget</span>(<span class="hljs-params">Vector2 pos, <span class="hljs-keyword">int</span> maxSpd=<span class="hljs-number">70</span>, <span class="hljs-keyword">int</span> rotateTime=<span class="hljs-number">250</span></span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> Movement <span class="hljs-title">NaviAwayTarget</span>(<span class="hljs-params">Vector2Int pos, <span class="hljs-keyword">int</span> maxSpd=<span class="hljs-number">70</span>, <span class="hljs-keyword">int</span> rotateTime=<span class="hljs-number">250</span></span>)</span>;</code></pre><p>目標座標から離れるようにナビゲーションする Movement を計算します。</p>
<ul>
<li>pos<ul>
<li>定義：目標座標</li>
</ul>
</li>
</ul>
<br>

<p>簡潔化したサンプルコード</p>
<pre><code class="hljs c#"><span class="hljs-comment">// 目標へナビゲーションする Movement を計算</span>
Movement mv = cubeNavigator.Navi2Target(x, y);
<span class="hljs-comment">// 実行</span>
mv.Exec();</code></pre><p>或いは</p>
<pre><code class="hljs c#"><span class="hljs-comment">// 目標へナビゲーションする Movement を計算 ＆ 実行</span>
Movement mv = cubeNavigator.Navi2Target(x, y).Exec();</code></pre><br>

<h1 id="3-hlavoid-クラス-api">3. HLAvoid クラス API</h1>
<p>衝突回避アルゴリズムを実装したクラスです。</p>
<p>CubeNavigator クラスが HLAvoid のインスタンスを持っているので、
CubeNavigator クラスから HLAvoid のパラメーターを変更したり、情報を取得したりするには以下のようにします。</p>
<pre><code class="hljs c#">CubeNavigator navigator = ...
<span class="hljs-comment">// 例として、パラメーター range を変更</span>
navigator.avoid.range = <span class="hljs-number">220</span>;</code></pre><h2 id="31-スキャン結果構造体-scanresult">3.1. スキャン結果構造体 ScanResult</h2>
<pre><code class="hljs c#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> ScanResult
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> isCollision;    <span class="hljs-comment">// 衝突状態</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span>[] rads;       <span class="hljs-comment">// スキャンの方向</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span>[] dists;      <span class="hljs-comment">// 距離</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span>[] safety;     <span class="hljs-comment">// 安全性</span>
    <span class="hljs-keyword">public</span> Vector[] points;     <span class="hljs-comment">// 方向と距離で決まるポイントの相対座標</span>

    <span class="hljs-comment">// 初期化済みの ScanResult を作成用</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ScanResult <span class="hljs-title">init</span>(<span class="hljs-params"><span class="hljs-keyword">double</span>[] rads, <span class="hljs-keyword">double</span> maxRange</span>)</span>;
    <span class="hljs-comment">// デバッグ用</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print</span>(<span class="hljs-params">Action&lt;<span class="hljs-keyword">string</span>&gt; func</span>)</span>;
    <span class="hljs-comment">// rads と dists で points を計算</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">calcPoints</span>(<span class="hljs-params"></span>)</span>;
}</code></pre><h2 id="32-パラメーター">3.2. パラメーター</h2>
<pre><code class="hljs c#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> range = <span class="hljs-number">200</span>;  <span class="hljs-comment">// 見える距離</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> nsample = <span class="hljs-number">19</span>;    <span class="hljs-comment">// 周囲をスキャンする時の角度の数、奇数を勧める</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> margin = <span class="hljs-number">22</span>;  <span class="hljs-comment">// 回避用の自分のマージン</span>

<span class="hljs-comment">// RunTowards 用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> useSafety = <span class="hljs-literal">true</span>;                       <span class="hljs-comment">// ScanResult.safety を使うか</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> p_waypoint_safety_threshold = <span class="hljs-number">0.15</span>;   <span class="hljs-comment">// ウェイポイント選択時の safety の閾値</span>

<span class="hljs-comment">// RunAway 用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> p_runaway_penalty_away_k = <span class="hljs-number">5</span>;     <span class="hljs-comment">// 目標に近づかないためのペナルティ</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> p_runaway_penalty_keeprad_k = <span class="hljs-number">10</span>; <span class="hljs-comment">// 方向を維持するためのペナルティ</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> p_runaway_range = <span class="hljs-number">250</span>;            <span class="hljs-comment">// スキャン結果をp_runaway_range/range倍に拡大</span></code></pre><h2 id="33-取得できる情報">3.3. 取得できる情報</h2>
<p>デバッグに使うのが便利です。</p>
<pre><code class="hljs c#"><span class="hljs-comment">// 保存した最後の計算結果</span>
<span class="hljs-keyword">public</span> ScanResult scanResult;   <span class="hljs-comment">// スキャン結果</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> waypointIndex = <span class="hljs-number">0</span>;   <span class="hljs-comment">// 選択したウェイポイントのインデックス</span></code></pre><h2 id="34-メソッド">3.4. メソッド</h2>
<p>Navigator の GetWaypointTo, GetWaypointAway に呼ばれています。</p>
<p>直に使う必要がないです。</p>
<h3 id="runtowards">RunTowards</h3>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">virtual</span> (<span class="hljs-params">Vector, <span class="hljs-keyword">bool</span>, <span class="hljs-keyword">double</span></span>) <span class="hljs-title">RunTowards</span>(<span class="hljs-params">List&lt;Navigator&gt; others, Entity target, List&lt;Wall&gt; walls</span>)</span>;</code></pre><p>目標個体へナビゲーションします。</p>
<ul>
<li>others<ul>
<li>定義：他 Navigator リスト</li>
</ul>
</li>
<li>target<ul>
<li>定義：目標個体</li>
</ul>
</li>
<li>walls<ul>
<li>定義：壁リスト</li>
</ul>
</li>
<li>戻り値: ウェイポイント、衝突状態、速度上限</li>
</ul>
<h3 id="runaway">RunAway</h3>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">virtual</span> (<span class="hljs-params">Vector, <span class="hljs-keyword">bool</span>, <span class="hljs-keyword">double</span></span>) <span class="hljs-title">RunAway</span>(<span class="hljs-params">List&lt;Navigator&gt; others, Entity target, List&lt;Wall&gt; walls</span>)</span>;</code></pre><p>目標個体から逃げるようにナビゲーションします。</p>
<ul>
<li>others<ul>
<li>定義：他 Navigator リスト</li>
</ul>
</li>
<li>target<ul>
<li>定義：目標個体</li>
</ul>
</li>
<li>walls<ul>
<li>定義：壁リスト</li>
</ul>
</li>
<li>戻り値: ウェイポイント、衝突状態、速度上限</li>
</ul>
<br>

<h1 id="4-boids-クラス-api">4. Boids クラス API</h1>
<p>ボイドアルゴリズムを実装したクラスです。</p>
<p>CubeNavigator クラスが Boids のインスタンスを持っているので、
CubeNavigator クラスから Boids のパラメーターを変更したり、情報を取得したりするには以下のようにします。</p>
<pre><code class="hljs c#">CubeNavigator navigator = ...
<span class="hljs-comment">// 例として、パラメーター range を変更</span>
navigator.boids.range = <span class="hljs-number">180</span>;</code></pre><h2 id="41-パラメーター">4.1. パラメーター</h2>
<pre><code class="hljs c#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> fov = Deg2Rad(<span class="hljs-number">120</span>);       <span class="hljs-comment">// 視野</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> range = <span class="hljs-number">150</span>;              <span class="hljs-comment">// 見える距離</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> margin = <span class="hljs-number">25</span>;              <span class="hljs-comment">// ボイド用のマージン</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> p_weight_attraction = <span class="hljs-number">50</span>; <span class="hljs-comment">// 目標に移動するベクトルの重み</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> p_weight_separation = <span class="hljs-number">1</span>;  <span class="hljs-comment">// 離れるベクトルの重み</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> p_max_separation = <span class="hljs-number">100</span>;   <span class="hljs-comment">// 離れるベクトルの上限</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> p_weight_cohesion = <span class="hljs-number">0.3</span>;  <span class="hljs-comment">// 平均位置に移動するベクトルの重み</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> p_max_cohesion = <span class="hljs-number">50</span>;      <span class="hljs-comment">// 平均位置に移動するベクトルの上限</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> p_weight_alignment = <span class="hljs-number">0.3</span>; <span class="hljs-comment">// 平均方向に向かうベクトルの重み</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> p_max_alignment = <span class="hljs-number">30</span>;     <span class="hljs-comment">// 平均方向に向かうベクトルの上限</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> p_max_all = <span class="hljs-number">100</span>;          <span class="hljs-comment">// 合ベクトルの上限</span></code></pre><h2 id="42-メソッド">4.2. メソッド</h2>
<h3 id="run">Run</h3>
<pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> Vector <span class="hljs-title">Run</span>(<span class="hljs-params">List&lt;Navigator&gt; others, Vector tarPos</span>)</span>;</code></pre><p>目標へのベクトルを含め、合ベクトルを計算します</p>
<ul>
<li>others<ul>
<li>定義：他 Navigator リスト</li>
</ul>
</li>
<li>tarPos<ul>
<li>定義：目標座標</li>
</ul>
</li>
<li>戻り値: 合ベクトル</li>
</ul>
<pre><code class="hljs c#"><span class="hljs-comment">// 合ベクトルを計算、目標なし</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Vector <span class="hljs-title">Run</span>(<span class="hljs-params">List&lt;Navigator&gt; others</span>)</span>;</code></pre><p>目標へのベクトルを除き、合ベクトルを計算します</p>
<ul>
<li>others<ul>
<li>定義：他 Navigator リスト</li>
</ul>
</li>
<li>戻り値: 合ベクトル</li>
</ul>



</body></html>
